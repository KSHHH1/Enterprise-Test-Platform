<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ä¼ä¸šæµ‹è¯•å¹³å° - ä¸»æœºç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
            background: white;
        }
        
        /* å·¦ä¾§æµ‹è¯•æœºåˆ—è¡¨ */
        .sidebar {
            width: 350px;
            background: #f8f9fa;
            border-right: 2px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .sidebar-header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .sidebar-header p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .sidebar-controls {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .sidebar-controls .btn {
            width: 100%;
            margin-bottom: 8px;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        .hosts-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .host-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .host-item:hover {
            border-color: #3498db;
            transform: translateX(5px);
        }
        
        .host-item.active {
            border-color: #3498db;
            background: #e8f4fd;
        }
        
        .host-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 4px 0 0 4px;
        }
        
        .host-item.online::before {
            background: #27ae60;
        }
        
        .host-item.offline::before {
            background: #e74c3c;
        }
        
        .host-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .host-details {
            font-size: 0.85em;
            color: #7f8c8d;
        }
        
        .host-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 5px;
        }
        
        .status-online {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .status-busy {
            background: #fef9e7;
            color: #f39c12;
        }
        
        .status-offline {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        /* å³ä¾§æµ‹è¯•é¡µé¢ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .content-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .content-header h2 {
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .content-header p {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .test-content {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
        }
        
        .test-panel {
            width: 400px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            height: fit-content;
        }
        
        .logs-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .panel-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .serials-list {
            margin-bottom: 20px;
        }
        
        .serial-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        
        .test-cases-section {
            margin-bottom: 20px;
        }
        
        .test-cases-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .test-case-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .test-case-item:hover {
            border-color: #3498db;
            background: #e8f4fd;
        }
        
        .test-case-item.selected {
            border-color: #27ae60;
            background: #d5f4e6;
        }
        
        .test-case-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .test-case-desc {
            font-size: 0.75em;
            color: #7f8c8d;
        }
        
        /* å¼€å…³æ§ä»¶æ ·å¼ */
        .switch-section {
            margin-bottom: 20px;
        }
        
        .switch-controls {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
        }
        
        .switch-item {
            margin-bottom: 12px;
        }
        
        .switch-item:last-child {
            margin-bottom: 0;
        }
        
        .switch-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .switch-text {
            flex: 1;
        }
        
        .switch-container {
            position: relative;
            width: 50px;
            height: 24px;
        }
        
        .switch-input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 24px;
        }
        
        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .switch-input:checked + .switch-slider {
            background-color: #27ae60;
        }
        
        .switch-input:focus + .switch-slider {
            box-shadow: 0 0 1px #27ae60;
        }
        
        .switch-input:checked + .switch-slider:before {
            transform: translateX(26px);
        }
        
        .switch-slider:hover {
            background-color: #bbb;
        }
        
        .switch-input:checked + .switch-slider:hover {
            background-color: #219a52;
        }
        
        .test-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .download-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }
        
        .logs-container {
            flex: 1;
            background: #2c3e50;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #ecf0f1;
            height: 500px; /* å›ºå®šé«˜åº¦ */
            max-height: 500px; /* æœ€å¤§é«˜åº¦é™åˆ¶ */
            border: 1px solid #34495e;
            position: relative;
        }
        
        .logs-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .logs-container::-webkit-scrollbar-track {
            background: #34495e;
            border-radius: 4px;
        }
        
        .logs-container::-webkit-scrollbar-thumb {
            background: #7f8c8d;
            border-radius: 4px;
        }
        
        .logs-container::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }
        
        .log-count {
            font-size: 12px;
            color: #7f8c8d;
            font-weight: normal;
            margin-left: 8px;
        }
        
        .log-entry {
            margin: 3px 0;
            padding: 3px 0;
            line-height: 1.4;
        }
        
        .log-info {
            color: #3498db;
        }
        
        .log-success {
            color: #27ae60;
        }
        
        .log-error {
            color: #e74c3c;
        }
        
        .log-warn {
            color: #f39c12;
        }
        
        .welcome-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #7f8c8d;
            text-align: center;
        }
        
        .welcome-screen h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .welcome-screen p {
            font-size: 1.1em;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§æµ‹è¯•æœºåˆ—è¡¨ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1>ğŸ–¥ï¸ ä¼ä¸šæµ‹è¯•å¹³å°</h1>
                <p>ä¸»æœºç®¡ç†ä¸æµ‹è¯•ç³»ç»Ÿ</p>
            </div>
            
            <div class="sidebar-controls">
                <button class="btn btn-primary" onclick="refreshHosts()">ğŸ”„ åˆ·æ–°ä¸»æœºåˆ—è¡¨</button>
                <button class="btn btn-success" onclick="discoverHosts()">ğŸ” è‡ªåŠ¨å‘ç°ä¸»æœº</button>
                <button class="btn btn-primary" onclick="showAddHostModal()">â• æ·»åŠ ä¸»æœº</button>
            </div>
            
            <div class="hosts-list" id="hostsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åŠ è½½ä¸»æœºåˆ—è¡¨...</p>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§æµ‹è¯•é¡µé¢ -->
        <div class="main-content">
            <div class="content-header">
                <h2 id="selectedHostTitle">è¯·é€‰æ‹©æµ‹è¯•æœº</h2>
                <p id="selectedHostInfo">ä»å·¦ä¾§åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªåœ¨çº¿çš„æµ‹è¯•æœºå¼€å§‹æµ‹è¯•</p>
            </div>
            
            <div id="testInterface" style="display: none;">
                <div class="test-content">
                    <!-- æµ‹è¯•æ§åˆ¶é¢æ¿ -->
                    <div class="test-panel">
                        <div class="panel-title">ğŸ”Œ å¯ç”¨ä¸²å£</div>
                        <div class="serials-list" id="serialsList">
                            <div class="loading">
                                <p>åŠ è½½ä¸­...</p>
                            </div>
                        </div>
                        
                        <div class="test-cases-section">
                            <div class="panel-title">ğŸ“‹ æµ‹è¯•ç”¨ä¾‹</div>
                            <div class="test-cases-grid" id="testCasesGrid">
                                <div class="loading">
                                    <p>åŠ è½½ä¸­...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å¼€å…³æ§åˆ¶åŒºåŸŸ -->
                        <div class="switch-section">
                            <div class="panel-title">ğŸ”§ è®¾å¤‡æ§åˆ¶</div>
                            <div class="switch-controls">
                                <div class="switch-item">
                                    <label class="switch-label">
                                        <span class="switch-text">å ç”¨æ§åˆ¶</span>
                                        <div class="switch-container">
                                            <input type="checkbox" id="occupySwitch" class="switch-input" onchange="toggleOccupySwitch(this)">
                                            <span class="switch-slider"></span>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="test-actions">
                            <button class="btn btn-success" id="startTestBtn" onclick="startTest()" disabled>å¼€å§‹æµ‹è¯•</button>
                            <button class="btn btn-danger" id="stopTestBtn" onclick="stopTest()" style="display:none;">åœæ­¢æµ‹è¯•</button>
                        </div>
                    </div>
                    
                    <!-- æ—¥å¿—æ˜¾ç¤ºé¢æ¿ -->
                    <div class="logs-panel">
                        <div class="logs-header">
                            <div class="panel-title">ğŸ“„ æµ‹è¯•æ—¥å¿— <span id="logCount" class="log-count">(0æ¡)</span></div>
                            <div class="download-actions">
                                <button class="btn btn-info btn-sm" onclick="downloadReport()">ğŸ“Š ä¸‹è½½æŠ¥å‘Š</button>
                                <button class="btn btn-info btn-sm" onclick="downloadLogs()">ğŸ“‹ ä¸‹è½½æ—¥å¿—</button>
                                <button class="btn btn-primary btn-sm" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                            </div>
                        </div>
                        <div class="logs-container" id="logsContainer">
                            <div class="log-entry log-info">[INFO] ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="welcomeScreen" class="welcome-screen">
                <h3>ğŸš€ æ¬¢è¿ä½¿ç”¨ä¼ä¸šæµ‹è¯•å¹³å°</h3>
                <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªåœ¨çº¿çš„æµ‹è¯•æœºå¼€å§‹æµ‹è¯•</p>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ ä¸»æœºæ¨¡æ€æ¡† -->
    <div id="addHostModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddHostModal()">&times;</span>
            <h2>æ·»åŠ æ–°ä¸»æœº</h2>
            <form id="addHostForm">
                <div class="form-group">
                    <label for="hostName">ä¸»æœºåç§°:</label>
                    <input type="text" id="hostName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="hostIp">IPåœ°å€:</label>
                    <input type="text" id="hostIp" name="ip" required pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
                </div>
                <div class="form-group">
                    <label for="hostPort">ç«¯å£:</label>
                    <input type="number" id="hostPort" name="port" value="5001" min="1" max="65535">
                </div>
                <div class="form-group">
                    <label for="hostLocation">ä½ç½®:</label>
                    <input type="text" id="hostLocation" name="location">
                </div>
                <button type="submit" class="btn btn-primary">æ·»åŠ ä¸»æœº</button>
            </form>
        </div>
    </div>

    <script>
        // ç”¨æˆ·ç®¡ç†å’Œç™»å½•æ£€æŸ¥
        let currentUser = null;
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
        
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLoginStatus() {
            try {
                const response = await fetch('http://localhost:5002/api/user_info');
                if (response.ok) {
                    const userInfo = await response.json();
                    if (userInfo.success) {
                        currentUser = userInfo;
                        initializeMainInterface();
                        return;
                    }
                }
            } catch (error) {
                console.log('ç”¨æˆ·æœªç™»å½•æˆ–ä¼šè¯å·²è¿‡æœŸ');
            }
            
            // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
            window.location.href = 'login.html';
        }
        
        // åˆå§‹åŒ–ä¸»ç•Œé¢
        function initializeMainInterface() {
            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            updateUserInfo();
            
            // åˆ·æ–°ä¸»æœºåˆ—è¡¨
            refreshHosts();
            
            // ç«‹å³æ£€æŸ¥ä¸€æ¬¡æµ‹è¯•æœºçŠ¶æ€
            checkAllMachineStatus();
            
            // åˆå§‹åŒ–æ—¥å¿—è®¡æ•°å™¨
            updateLogCount();
            
            // å®šæœŸæ£€æŸ¥æµ‹è¯•æœºçŠ¶æ€
            setInterval(checkAllMachineStatus, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
        }
        
        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
        function updateUserInfo() {
            if (!currentUser) return;
            
            // åœ¨é¡µé¢å¤´éƒ¨æ·»åŠ ç”¨æˆ·ä¿¡æ¯
            const header = document.querySelector('.sidebar-header');
            if (header && !header.querySelector('.user-info')) {
                const userInfoDiv = document.createElement('div');
                userInfoDiv.className = 'user-info';
                userInfoDiv.style.cssText = `
                    margin-top: 10px;
                    padding: 10px;
                    background: rgba(255,255,255,0.1);
                    border-radius: 5px;
                    font-size: 0.8em;
                `;
                userInfoDiv.innerHTML = `
                    <div>ç”¨æˆ·: ${currentUser.user_name}</div>
                    <div>IP: ${currentUser.client_ip}</div>
                    <button onclick="logout()" style="
                        margin-top: 5px;
                        padding: 3px 8px;
                        background: rgba(255,255,255,0.2);
                        border: 1px solid rgba(255,255,255,0.3);
                        border-radius: 3px;
                        color: white;
                        cursor: pointer;
                        font-size: 0.8em;
                    ">ç™»å‡º</button>
                `;
                header.appendChild(userInfoDiv);
            }
        }
        
        // ç™»å‡ºåŠŸèƒ½
        async function logout() {
            try {
                await fetch('http://localhost:5002/api/logout', {
                    method: 'POST'
                });
            } catch (error) {
                console.error('ç™»å‡ºè¯·æ±‚å¤±è´¥:', error);
            }
            
            // æ¸…é™¤æœ¬åœ°çŠ¶æ€
            currentUser = null;
            
            // æ¸…é™¤localStorageä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼Œé˜²æ­¢login.htmlè‡ªåŠ¨è·³è½¬å›æ¥
            localStorage.removeItem('userInfo');
            
            // è·³è½¬åˆ°ç™»å½•é¡µé¢
            window.location.href = 'login.html';
        }
        
        // æ£€æŸ¥æ‰€æœ‰æµ‹è¯•æœºçŠ¶æ€
        async function checkAllMachineStatus() {
            try {
                const response = await fetch('http://localhost:5002/api/machine_status');
                if (response.ok) {
                    const statusData = await response.json();
                    updateMachineStatusDisplay(statusData);
                }
            } catch (error) {
                console.error('æ£€æŸ¥æµ‹è¯•æœºçŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°æµ‹è¯•æœºçŠ¶æ€æ˜¾ç¤º
        function updateMachineStatusDisplay(statusData) {
            const hostItems = document.querySelectorAll('.host-item');
            hostItems.forEach(item => {
                const hostDetailsDiv = item.querySelector('.host-details');
                if (!hostDetailsDiv) return;
                
                const ipDiv = hostDetailsDiv.querySelector('div');
                if (!ipDiv) return;
                
                const hostIp = ipDiv.textContent.replace('IP: ', '');
                const statusElement = item.querySelector('.host-status');
                if (!statusElement) return;
                
                // æ£€æŸ¥è¯¥æµ‹è¯•æœºçŠ¶æ€
                const machineStatus = statusData[hostIp];
                if (machineStatus && !machineStatus.available) {
                    // æµ‹è¯•æœºè¢«å ç”¨
                    const session = machineStatus.session;
                    if (session) {
                        const occupiedBy = session.user_name;
                        const isCurrentUser = currentUser && session.user_id === currentUser.user_id;
                        
                        // æ£€æŸ¥æ˜¯å¦æ­£åœ¨è¿è¡Œæµ‹è¯•ï¼ˆé€šè¿‡æ£€æŸ¥test_caseæ˜¯å¦ä¸º"å¼€å…³å ç”¨"æ¥åˆ¤æ–­ï¼‰
                        const isRunningTest = session.test_case && session.test_case !== "å¼€å…³å ç”¨";
                        
                        if (isCurrentUser) {
                            // å½“å‰ç”¨æˆ·å ç”¨çš„æµ‹è¯•æœº
                            if (isRunningTest) {
                                // æ­£åœ¨è¿è¡Œæµ‹è¯•
                                statusElement.textContent = 'æµ‹è¯•ä¸­(æˆ‘çš„)';
                                statusElement.className = 'host-status status-busy';
                            } else {
                                // ä»…å ç”¨ä½†æœªè¿è¡Œæµ‹è¯•
                                statusElement.textContent = 'å ç”¨ä¸­(æˆ‘çš„)';
                                statusElement.className = 'host-status status-busy';
                            }
                            item.style.opacity = '1';
                            item.style.pointerEvents = 'auto';
                        } else {
                            // å…¶ä»–ç”¨æˆ·å ç”¨çš„æµ‹è¯•æœº
                            if (isRunningTest) {
                                // æ­£åœ¨è¿è¡Œæµ‹è¯•
                                statusElement.textContent = `æµ‹è¯•ä¸­(${occupiedBy})`;
                                statusElement.className = 'host-status status-busy';
                            } else {
                                // ä»…å ç”¨ä½†æœªè¿è¡Œæµ‹è¯•
                                statusElement.textContent = `å ç”¨ä¸­(${occupiedBy})`;
                                statusElement.className = 'host-status status-busy';
                            }
                            item.style.opacity = '0.6';
                            item.style.pointerEvents = 'none';
                        }
                    } else {
                        // æœ‰çŠ¶æ€ä½†æ²¡æœ‰ä¼šè¯ä¿¡æ¯ï¼Œæ˜¾ç¤ºå¿™ç¢Œ
                        statusElement.textContent = 'å¿™ç¢Œ';
                        statusElement.className = 'host-status status-busy';
                        item.style.opacity = '0.6';
                        item.style.pointerEvents = 'none';
                    }
                } else {
                    // ç©ºé—²çš„æµ‹è¯•æœº
                    statusElement.textContent = 'åœ¨çº¿';
                    statusElement.className = 'host-status status-online';
                    item.style.opacity = '1';
                    item.style.pointerEvents = 'auto';
                }
            });
        }
        
        let currentHost = null;
        let currentTestId = null;
        let testPollingInterval = null;
        let selectedTestCase = null;
        let testLogs = [];
        
        // ä¸ºæ¯ä¸ªæµ‹è¯•æœºç»´æŠ¤ç‹¬ç«‹çš„çŠ¶æ€
        let hostStates = {}; // å­˜å‚¨æ¯ä¸ªæµ‹è¯•æœºçš„çŠ¶æ€ä¿¡æ¯
        
        // åˆ·æ–°ä¸»æœºåˆ—è¡¨
        async function refreshHosts() {
            try {
                const response = await fetch('http://localhost:5002/api/hosts');
                const hosts = await response.json();
                displayHosts(hosts);
            } catch (error) {
                console.error('è·å–ä¸»æœºåˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('hostsList').innerHTML = 
                    '<div class="loading"><p>âŒ è·å–ä¸»æœºåˆ—è¡¨å¤±è´¥</p></div>';
            }
        }
        
        // æ˜¾ç¤ºä¸»æœºåˆ—è¡¨
        function displayHosts(hosts) {
            const container = document.getElementById('hostsList');
            
            if (hosts.length === 0) {
                container.innerHTML = '<div class="loading"><p>ğŸ“­ æš‚æ— ä¸»æœº</p></div>';
                return;
            }
            
            const hostsHtml = hosts.map(host => `
                <div class="host-item ${host.status === 'åœ¨çº¿' ? 'online' : 'offline'}" 
                     onclick="selectHost('${host.ip}', '${host.name}', '${host.status}')">
                    <div class="host-name">${host.name}</div>
                    <div class="host-details">
                        <div>IP: ${host.ip}</div>
                        <div>ä½ç½®: ${host.location || 'æœªè®¾ç½®'}</div>
                    </div>
                    <div class="host-status ${host.status === 'åœ¨çº¿' ? 'status-online' : 'status-offline'}">
                        ${host.status}
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = hostsHtml;
        }
        
        // æ›´æ–°ä¸»æœºå¿™ç¢ŒçŠ¶æ€
        function updateHostBusyStatus(hostIp, isBusy) {
            const hostItems = document.querySelectorAll('.host-item');
            hostItems.forEach(item => {
                // å®‰å…¨è·å–IPåœ°å€
                const hostDetailsDiv = item.querySelector('.host-details');
                if (!hostDetailsDiv) return;
                
                const ipDiv = hostDetailsDiv.querySelector('div');
                if (!ipDiv) return;
                
                const itemHostIp = ipDiv.textContent.replace('IP: ', '');
                if (itemHostIp === hostIp) {
                    const statusElement = item.querySelector('.host-status');
                    if (!statusElement) return; // å®‰å…¨æ£€æŸ¥
                    
                    if (isBusy) {
                        statusElement.textContent = 'å¿™ç¢Œ';
                        statusElement.className = 'host-status status-busy';
                        // ç§»é™¤ç¦ç”¨ç‚¹å‡»çš„é€»è¾‘ï¼Œå…è®¸ç”¨æˆ·æŸ¥çœ‹æ­£åœ¨æµ‹è¯•çš„æœºå™¨çŠ¶æ€
                    } else {
                        statusElement.textContent = 'åœ¨çº¿';
                        statusElement.className = 'host-status status-online';
                    }
                }
            });
        }

        // é€‰æ‹©ä¸»æœº
        async function selectHost(ip, name, status) {
            // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.host-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
            event.currentTarget.classList.add('active');
            
            if (status !== 'åœ¨çº¿' && !status.includes('å¿™ç¢Œ')) {
                alert('è¯¥ä¸»æœºå½“å‰ç¦»çº¿ï¼Œæ— æ³•è¿›è¡Œæµ‹è¯•');
                return;
            }
            
            // æ£€æŸ¥æµ‹è¯•æœºæ˜¯å¦è¢«å…¶ä»–ç”¨æˆ·å ç”¨
            try {
                const response = await fetch('http://localhost:5002/api/machine_status');
                if (response.ok) {
                    const statusData = await response.json();
                    const machineStatus = statusData[ip];
                    
                    if (machineStatus && machineStatus.occupied) {
                        const isCurrentUser = currentUser && machineStatus.user_id === currentUser.user_id;
                        
                        if (!isCurrentUser) {
                            alert(`è¯¥æµ‹è¯•æœºæ­£è¢«ç”¨æˆ· ${machineStatus.user_name} å ç”¨ï¼Œæ— æ³•æ“ä½œ`);
                            return;
                        }
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥æµ‹è¯•æœºçŠ¶æ€å¤±è´¥:', error);
            }
            
            // ä¿å­˜å½“å‰ä¸»æœºçš„çŠ¶æ€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if (currentHost) {
                saveCurrentHostState();
            }
            
            // åˆ‡æ¢åˆ°æ–°ä¸»æœº
            currentHost = { ip, name };
            
            // åˆå§‹åŒ–æ–°ä¸»æœºçŠ¶æ€ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            if (!hostStates[ip]) {
                hostStates[ip] = {
                    testId: null,
                    testCase: null,
                    logs: [],
                    isRunning: false,
                    pollingInterval: null
                };
            }
            
            // æ¢å¤æ–°ä¸»æœºçš„çŠ¶æ€
            restoreHostState(ip);
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('selectedHostTitle').textContent = `${name} (${ip})`;
            document.getElementById('selectedHostInfo').textContent = 'æ­£åœ¨åŠ è½½ä¸²å£å’Œæµ‹è¯•ç”¨ä¾‹...';
            
            // æ˜¾ç¤ºæµ‹è¯•ç•Œé¢
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('testInterface').style.display = 'block';
            
            // åˆå§‹åŒ–æµ‹è¯•æœºçŠ¶æ€ï¼ˆé»˜è®¤å…³é—­å ç”¨å¼€å…³ï¼Œç¦ç”¨æ‰€æœ‰æŒ‰é’®ï¼‰
            initializeTestMachineState();
            
            // åŠ è½½ä¸²å£å’Œæµ‹è¯•ç”¨ä¾‹
            await loadSerials(ip);
            await loadTestCases(ip);
            
            // ä¸è‡ªåŠ¨åŠ è½½å¼€å…³çŠ¶æ€ï¼Œä¿æŒé»˜è®¤çš„å…³é—­çŠ¶æ€
            // ç”¨æˆ·éœ€è¦æ‰‹åŠ¨æ“ä½œå¼€å…³
            
            document.getElementById('selectedHostInfo').textContent = 'è¯·æ‰“å¼€å ç”¨æ§åˆ¶å¼€å…³åé€‰æ‹©æµ‹è¯•ç”¨ä¾‹å¹¶å¼€å§‹æµ‹è¯•';
        }
        
        // ä¿å­˜å½“å‰ä¸»æœºçŠ¶æ€
        function saveCurrentHostState() {
            if (!currentHost) return;
            
            const ip = currentHost.ip;
            if (!hostStates[ip]) {
                hostStates[ip] = {};
            }
            
            hostStates[ip].testId = currentTestId;
            hostStates[ip].testCase = selectedTestCase;
            hostStates[ip].logs = [...testLogs]; // å¤åˆ¶æ•°ç»„
            hostStates[ip].isRunning = testPollingInterval !== null;
            hostStates[ip].pollingInterval = testPollingInterval;
            
            // ä¿å­˜å¼€å…³çŠ¶æ€
            hostStates[ip].switchStates = {
                occupy: document.getElementById('occupySwitch').checked
            };
        }
        
        // æ¢å¤ä¸»æœºçŠ¶æ€
        function restoreHostState(ip) {
            const state = hostStates[ip];
            if (!state) return;
            
            // åœæ­¢å½“å‰çš„è½®è¯¢ï¼ˆå¦‚æœæœ‰ï¼‰
            if (testPollingInterval) {
                clearInterval(testPollingInterval);
                testPollingInterval = null;
            }
            
            // æ¢å¤çŠ¶æ€å˜é‡
            currentTestId = state.testId;
            selectedTestCase = state.testCase;
            testLogs = [...(state.logs || [])]; // å¤åˆ¶æ•°ç»„
            testPollingInterval = state.pollingInterval;
            
            // æ¢å¤UIçŠ¶æ€
            restoreUIState(state);
            
            // å¦‚æœæœ‰æ­£åœ¨è¿è¡Œçš„æµ‹è¯•ï¼Œæ¢å¤è½®è¯¢
            if (state.isRunning && state.testId) {
                startTestPolling();
            }
        }
        
        // æ¢å¤UIçŠ¶æ€
        function restoreUIState(state) {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            const startBtn = document.getElementById('startTestBtn');
            const stopBtn = document.getElementById('stopTestBtn');
            
            if (state.isRunning) {
                if (startBtn) startBtn.style.display = 'none';
                if (stopBtn) stopBtn.style.display = 'inline-block';
            } else {
                if (startBtn) startBtn.style.display = 'inline-block';
                if (stopBtn) stopBtn.style.display = 'none';
            }
            
            // æ¢å¤æµ‹è¯•ç”¨ä¾‹é€‰æ‹©
            if (state.testCase) {
                setTimeout(() => {
                    const testCaseItems = document.querySelectorAll('.test-case-item');
                    testCaseItems.forEach(item => {
                        const caseName = item.onclick.toString().match(/'([^']+)'/)[1];
                        if (caseName === state.testCase) {
                            item.classList.add('selected');
                        } else {
                            item.classList.remove('selected');
                        }
                    });
                    
                    // å¯ç”¨å¼€å§‹æµ‹è¯•æŒ‰é’®
                    const startTestBtn = document.getElementById('startTestBtn');
                    if (startTestBtn) {
                        startTestBtn.disabled = false;
                    }
                }, 100);
            }
            
            // æ¢å¤æ—¥å¿—æ˜¾ç¤º
            const container = document.getElementById('logsContainer');
            if (container) {
                container.innerHTML = '';
                if (state.logs && state.logs.length > 0) {
                    state.logs.forEach(log => {
                        let logType = 'info';
                        if (log.includes('[SUCCESS]')) logType = 'success';
                        else if (log.includes('[ERROR]')) logType = 'error';
                        else if (log.includes('[WARN]')) logType = 'warn';
                        
                        const logEntry = document.createElement('div');
                        logEntry.className = `log-entry log-${logType}`;
                        logEntry.textContent = log;
                        container.appendChild(logEntry);
                    });
                    container.scrollTop = container.scrollHeight;
                } else {
                    container.innerHTML = '<div class="log-entry log-info">[INFO] æš‚æ— æ—¥å¿—</div>';
                }
            }
            
            // æ›´æ–°æ—¥å¿—è®¡æ•°å™¨
            updateLogCount();
            
            // æ¢å¤å¼€å…³çŠ¶æ€
            if (state.switchStates) {
                document.getElementById('occupySwitch').checked = state.switchStates.occupy || false;
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„çŠ¶æ€ï¼Œé‡ç½®ä¸ºé»˜è®¤çŠ¶æ€
                resetSwitchStates();
            }
        }
        
        // åŠ è½½ä¸²å£åˆ—è¡¨
        async function loadSerials(ip) {
            try {
                const response = await fetch(`http://localhost:5002/api/hosts/${ip}/serials`);
                const result = await response.json();
                
                const container = document.getElementById('serialsList');
                
                if (result.success && result.data && result.data.length > 0) {
                    const serialsHtml = result.data.map(serial => `
                        <div class="serial-item">
                            <strong>${serial.device}</strong><br>
                            <small>${serial.description}</small>
                        </div>
                    `).join('');
                    container.innerHTML = serialsHtml;
                } else {
                    container.innerHTML = '<div class="loading"><p>âŒ æœªæ£€æµ‹åˆ°ä¸²å£</p></div>';
                }
            } catch (error) {
                console.error('åŠ è½½ä¸²å£åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('serialsList').innerHTML = 
                    '<div class="loading"><p>âŒ åŠ è½½å¤±è´¥</p></div>';
            }
        }
        
        // åŠ è½½æµ‹è¯•ç”¨ä¾‹åˆ—è¡¨
        async function loadTestCases(ip) {
            try {
                const response = await fetch(`http://localhost:5002/api/hosts/${ip}/cases`);
                const result = await response.json();
                
                const container = document.getElementById('testCasesGrid');
                
                if (result.success && result.data && result.data.length > 0) {
                    const casesHtml = result.data.map(testCase => `
                        <div class="test-case-item" onclick="selectTestCase('${testCase.name}', this)">
                            <div class="test-case-name">${testCase.display_name}</div>
                            <div class="test-case-desc">${testCase.description || 'æ— æè¿°'}</div>
                        </div>
                    `).join('');
                    container.innerHTML = casesHtml;
                } else {
                    container.innerHTML = '<div class="loading"><p>âŒ æœªæ‰¾åˆ°æµ‹è¯•ç”¨ä¾‹</p></div>';
                }
            } catch (error) {
                console.error('åŠ è½½æµ‹è¯•ç”¨ä¾‹å¤±è´¥:', error);
                document.getElementById('testCasesGrid').innerHTML = 
                    '<div class="loading"><p>âŒ åŠ è½½å¤±è´¥</p></div>';
            }
        }
        
        // é€‰æ‹©æµ‹è¯•ç”¨ä¾‹
        function selectTestCase(caseName, element) {
            // æ£€æŸ¥æ˜¯å¦å·²å ç”¨æµ‹è¯•æœº
            if (!document.getElementById('occupySwitch').checked) {
                alert('è¯·å…ˆæ‰“å¼€å ç”¨æ§åˆ¶å¼€å…³æ‰èƒ½é€‰æ‹©æµ‹è¯•ç”¨ä¾‹');
                return;
            }
            
            // ç§»é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.test-case-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // æ·»åŠ å½“å‰é€‰ä¸­çŠ¶æ€
            element.classList.add('selected');
            selectedTestCase = caseName;
            
            // å¯ç”¨å¼€å§‹æµ‹è¯•æŒ‰é’®
            updateButtonStates();
        }
        
        // å¼€å§‹æµ‹è¯•
        async function startTest() {
            // æ£€æŸ¥æ˜¯å¦å·²å ç”¨æµ‹è¯•æœº
            if (!document.getElementById('occupySwitch').checked) {
                alert('è¯·å…ˆæ‰“å¼€å ç”¨æ§åˆ¶å¼€å…³æ‰èƒ½å¼€å§‹æµ‹è¯•');
                return;
            }
            
            if (!currentHost || !selectedTestCase) {
                alert('è¯·é€‰æ‹©ä¸»æœºå’Œæµ‹è¯•ç”¨ä¾‹');
                return;
            }
            
            if (!currentUser) {
                alert('ç”¨æˆ·æœªç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5002/api/hosts/${currentHost.ip}/run_case`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        case_name: selectedTestCase,
                        serial_port: 'auto', // è‡ªåŠ¨é€‰æ‹©ä¸²å£
                        user_name: currentUser.user_name,
                        test_case: selectedTestCase
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentTestId = result.test_id;
                    
                    // ä¿å­˜çŠ¶æ€åˆ°hostStates
                    if (!hostStates[currentHost.ip]) {
                        hostStates[currentHost.ip] = {
                            testId: null,
                            testCase: null,
                            logs: [],
                            isRunning: false,
                            pollingInterval: null
                        };
                    }
                    
                    hostStates[currentHost.ip].testId = currentTestId;
                    hostStates[currentHost.ip].testCase = selectedTestCase;
                    hostStates[currentHost.ip].isRunning = true;
                    
                    // å®‰å…¨æ›´æ–°æŒ‰é’®çŠ¶æ€
                    const startBtn = document.getElementById('startTestBtn');
                    const stopBtn = document.getElementById('stopTestBtn');
                    if (startBtn) startBtn.style.display = 'none';
                    if (stopBtn) stopBtn.style.display = 'inline-block';
                    
                    // è®¾ç½®ä¸»æœºä¸ºå¿™ç¢ŒçŠ¶æ€
                    updateHostBusyStatus(currentHost.ip, true);
                    
                    // æ¸…ç©ºæ—¥å¿—å¹¶æ·»åŠ å¼€å§‹ä¿¡æ¯
                    testLogs = [];
                    addLog('info', `[INFO] å¼€å§‹æµ‹è¯•: ${selectedTestCase}`);
                    addLog('info', `[INFO] æµ‹è¯•ID: ${currentTestId}`);
                    addLog('info', `[INFO] ç”¨æˆ·: ${currentUser.user_name}`);
                    
                    // å¼€å§‹è½®è¯¢æµ‹è¯•çŠ¶æ€
                    startTestPolling();
                } else {
                    if (response.status === 409) {
                        alert(`æµ‹è¯•æœºè¢«å ç”¨: ${result.error}`);
                    } else {
                        addLog('error', `[ERROR] å¯åŠ¨æµ‹è¯•å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                }
            } catch (error) {
                console.error('å¯åŠ¨æµ‹è¯•å¤±è´¥:', error);
                addLog('error', `[ERROR] å¯åŠ¨æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
        
        // åœæ­¢æµ‹è¯•
        async function stopTest() {
            if (!currentTestId) {
                alert('æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„æµ‹è¯•');
                return;
            }
            
            if (!currentUser) {
                alert('ç”¨æˆ·æœªç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•');
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5002/api/host/${currentHost.ip}/stop_test/${currentTestId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_name: currentUser.user_name
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('info', '[INFO] æµ‹è¯•å·²åœæ­¢');
                    addLog('info', `[INFO] ç”¨æˆ·: ${currentUser.user_name}`);
                    addLog('info', '[INFO] æµ‹è¯•æœºå ç”¨çŠ¶æ€ä¿æŒä¸å˜');
                    
                    // æ›´æ–°hostStatesçŠ¶æ€
                    if (hostStates[currentHost.ip]) {
                        hostStates[currentHost.ip].isRunning = false;
                        hostStates[currentHost.ip].testId = null;
                        if (hostStates[currentHost.ip].pollingInterval) {
                            clearInterval(hostStates[currentHost.ip].pollingInterval);
                            hostStates[currentHost.ip].pollingInterval = null;
                        }
                    }
                    
                    // åœæ­¢è½®è¯¢
                    if (testPollingInterval) {
                        clearInterval(testPollingInterval);
                        testPollingInterval = null;
                    }
                    
                    // å®‰å…¨æ¢å¤æŒ‰é’®çŠ¶æ€
                    const startBtn = document.getElementById('startTestBtn');
                    const stopBtn = document.getElementById('stopTestBtn');
                    if (startBtn) startBtn.style.display = 'inline-block';
                    if (stopBtn) stopBtn.style.display = 'none';
                    
                    // æ¢å¤ä¸»æœºçŠ¶æ€
                    updateHostBusyStatus(currentHost.ip, false);
                    
                    currentTestId = null;
                } else {
                    addLog('error', `[ERROR] åœæ­¢æµ‹è¯•å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('åœæ­¢æµ‹è¯•å¤±è´¥:', error);
                addLog('error', `[ERROR] åœæ­¢æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }
        
        // å¼€å§‹è½®è¯¢æµ‹è¯•çŠ¶æ€
        function startTestPolling() {
            if (testPollingInterval) {
                clearInterval(testPollingInterval);
            }
            
            testPollingInterval = setInterval(async () => {
                try {
                    const response = await fetch(`http://localhost:5002/api/host/${currentHost.ip}/test_status/${currentTestId}`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        updateTestLogs(result.data);
                        
                        if (result.data.status !== 'running') {
                            stopTestPolling();
                            addLog('info', `[INFO] æµ‹è¯•å®Œæˆï¼ŒçŠ¶æ€: ${result.data.status}`);
                        }
                    }
                } catch (error) {
                    console.error('è·å–æµ‹è¯•çŠ¶æ€å¤±è´¥:', error);
                }
            }, 1000);
            
            // ä¿å­˜è½®è¯¢é—´éš”åˆ°hostStates
            if (currentHost && hostStates[currentHost.ip]) {
                hostStates[currentHost.ip].pollingInterval = testPollingInterval;
            }
        }
        
        // åœæ­¢è½®è¯¢
        function stopTestPolling() {
            if (testPollingInterval) {
                clearInterval(testPollingInterval);
                testPollingInterval = null;
            }
            
            // æ¸…é™¤hostStatesä¸­çš„è½®è¯¢é—´éš”
            if (currentHost && hostStates[currentHost.ip]) {
                if (hostStates[currentHost.ip].pollingInterval) {
                    clearInterval(hostStates[currentHost.ip].pollingInterval);
                    hostStates[currentHost.ip].pollingInterval = null;
                }
                hostStates[currentHost.ip].isRunning = false;
            }
            
            // å®‰å…¨æ¢å¤æŒ‰é’®çŠ¶æ€
            const startBtn = document.getElementById('startTestBtn');
            const stopBtn = document.getElementById('stopTestBtn');
            if (startBtn) startBtn.style.display = 'inline-block';
            if (stopBtn) stopBtn.style.display = 'none';
            
            // æ¢å¤ä¸»æœºçŠ¶æ€
            if (currentHost) {
                updateHostBusyStatus(currentHost.ip, false);
            }
            
            currentTestId = null;
        }
        
        // æ›´æ–°æµ‹è¯•æ—¥å¿—
        function updateTestLogs(testData) {
            if (testData.logs && Array.isArray(testData.logs)) {
                testData.logs.forEach(log => {
                    if (!testLogs.includes(log)) {
                        testLogs.push(log);
                        
                        let logType = 'info';
                        if (log.includes('[SUCCESS]')) logType = 'success';
                        else if (log.includes('[ERROR]')) logType = 'error';
                        else if (log.includes('[WARN]')) logType = 'warn';
                        
                        addLog(logType, log);
                    }
                });
            }
        }
        
        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLog(type, message) {
            const container = document.getElementById('logsContainer');
            if (!container) return; // å®‰å…¨æ£€æŸ¥
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            
            container.appendChild(logEntry);
            
            // åŒæ—¶æ·»åŠ åˆ°å½“å‰ä¸»æœºçš„æ—¥å¿—æ•°ç»„ä¸­
            const fullLogMessage = `[${new Date().toLocaleTimeString()}] ${message}`;
            testLogs.push(fullLogMessage);
            
            // æ›´æ–°å½“å‰ä¸»æœºçŠ¶æ€ä¸­çš„æ—¥å¿—
            if (currentHost && hostStates[currentHost.ip]) {
                hostStates[currentHost.ip].logs = [...testLogs];
            }
            
            // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡ï¼Œé˜²æ­¢é¡µé¢å´©æºƒ
            const maxLogEntries = 1000; // æœ€å¤§æ—¥å¿—æ¡ç›®æ•°
            const logEntries = container.querySelectorAll('.log-entry');
            if (logEntries.length > maxLogEntries) {
                // åˆ é™¤æœ€æ—§çš„æ—¥å¿—æ¡ç›®
                const entriesToRemove = logEntries.length - maxLogEntries;
                for (let i = 0; i < entriesToRemove; i++) {
                    container.removeChild(logEntries[i]);
                }
                
                // åŒæ—¶ä»æ•°ç»„ä¸­åˆ é™¤
                testLogs.splice(0, entriesToRemove);
                if (currentHost && hostStates[currentHost.ip]) {
                    hostStates[currentHost.ip].logs = [...testLogs];
                }
            }
            
            // æ›´æ–°æ—¥å¿—è®¡æ•°å™¨
            updateLogCount();
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            container.scrollTop = container.scrollHeight;
        }
        
        // æ›´æ–°æ—¥å¿—è®¡æ•°å™¨
        function updateLogCount() {
            const container = document.getElementById('logsContainer');
            if (!container) return; // å®‰å…¨æ£€æŸ¥
            
            const logEntries = container.querySelectorAll('.log-entry');
            const count = logEntries.length;
            
            const logCountElement = document.getElementById('logCount');
            if (logCountElement) { // å®‰å…¨æ£€æŸ¥
                logCountElement.textContent = `(${count}æ¡)`;
            }
        }
        
        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            testLogs = [];
            
            // æ›´æ–°å½“å‰ä¸»æœºçŠ¶æ€ä¸­çš„æ—¥å¿—
            if (currentHost && hostStates[currentHost.ip]) {
                hostStates[currentHost.ip].logs = [];
            }
            
            const container = document.getElementById('logsContainer');
            if (container) { // å®‰å…¨æ£€æŸ¥
                container.innerHTML = '<div class="log-entry log-info">[INFO] æ—¥å¿—å·²æ¸…ç©º</div>';
            }
            // æ›´æ–°æ—¥å¿—è®¡æ•°å™¨
            updateLogCount();
        }
        
        // ä¸‹è½½æŠ¥å‘Š
        function downloadReport() {
            if (testLogs.length === 0) {
                alert('æš‚æ— æµ‹è¯•æ•°æ®å¯ä¸‹è½½');
                return;
            }
            
            const reportContent = generateReport();
            downloadFile('test_report.html', reportContent, 'text/html');
        }
        
        // ä¸‹è½½æ—¥å¿—
        function downloadLogs() {
            if (testLogs.length === 0) {
                alert('æš‚æ— æ—¥å¿—å¯ä¸‹è½½');
                return;
            }
            
            const logsContent = testLogs.join('\n');
            downloadFile('test_logs.txt', logsContent, 'text/plain');
        }
        
        // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        function generateReport() {
            const timestamp = new Date().toLocaleString();
            const hostInfo = currentHost ? `${currentHost.name} (${currentHost.ip})` : 'æœªçŸ¥';
            
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æµ‹è¯•æŠ¥å‘Š</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .log-entry { margin: 5px 0; padding: 5px; border-radius: 4px; font-family: monospace; }
        .log-info { background: #e8f4fd; color: #2980b9; }
        .log-success { background: #d5f4e6; color: #27ae60; }
        .log-error { background: #fadbd8; color: #e74c3c; }
        .log-warn { background: #fef9e7; color: #f39c12; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ä¼ä¸šæµ‹è¯•å¹³å° - æµ‹è¯•æŠ¥å‘Š</h1>
        <p><strong>ç”Ÿæˆæ—¶é—´:</strong> ${timestamp}</p>
        <p><strong>æµ‹è¯•ä¸»æœº:</strong> ${hostInfo}</p>
        <p><strong>æµ‹è¯•ç”¨ä¾‹:</strong> ${selectedTestCase || 'æœªçŸ¥'}</p>
        <p><strong>æµ‹è¯•ID:</strong> ${currentTestId || 'æœªçŸ¥'}</p>
    </div>
    <h2>æµ‹è¯•æ—¥å¿—</h2>
    <div class="logs">
        ${testLogs.map(log => {
            let logClass = 'log-info';
            if (log.includes('[SUCCESS]')) logClass = 'log-success';
            else if (log.includes('[ERROR]')) logClass = 'log-error';
            else if (log.includes('[WARN]')) logClass = 'log-warn';
            return `<div class="${logClass}">${log}</div>`;
        }).join('')}
    </div>
</body>
</html>`;
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadFile(filename, content, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // å¼€å…³æ§åˆ¶å‡½æ•°
        function toggleOccupySwitch(switchElement) {
            const isOn = switchElement.checked;
            const hostIp = currentHost ? currentHost.ip : null;
            
            if (!hostIp) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæµ‹è¯•æœº');
                switchElement.checked = false;
                return;
            }
            
            addLog('info', `[INFO] ${isOn ? 'å ç”¨' : 'é‡Šæ”¾'}æµ‹è¯•æœº`);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonStates();
            
            // å‘é€å¼€å…³çŠ¶æ€åˆ°åç«¯
            sendSwitchCommand('occupy', isOn, hostIp);
            
            // ç«‹å³æ›´æ–°æµ‹è¯•æœºçŠ¶æ€æ˜¾ç¤º
            setTimeout(() => {
                checkAllMachineStatus();
            }, 500); // ç»™åç«¯ä¸€ç‚¹æ—¶é—´å¤„ç†è¯·æ±‚
        }
        
        // å‘é€å¼€å…³å‘½ä»¤åˆ°åç«¯
        async function sendSwitchCommand(switchType, isOn, hostIp) {
            try {
                const response = await fetch(`http://localhost:5002/api/hosts/${hostIp}/switch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        switch_type: switchType,
                        state: isOn,
                        user_name: currentUser ? currentUser.user_name : 'unknown'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('success', `[SUCCESS] ${switchType}æ“ä½œæˆåŠŸ: ${isOn ? 'ON' : 'OFF'}`);
                } else {
                    addLog('error', `[ERROR] ${switchType}æ“ä½œå¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('å‘é€å¼€å…³å‘½ä»¤å¤±è´¥:', error);
                addLog('error', `[ERROR] å‘é€${switchType}å‘½ä»¤å¤±è´¥: ${error.message}`);
            }
        }
        
        // é‡ç½®å¼€å…³çŠ¶æ€
        function resetSwitchStates() {
            document.getElementById('occupySwitch').checked = false;
            // é‡ç½®åæ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonStates();
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonStates() {
            const isOccupied = document.getElementById('occupySwitch').checked;
            const startBtn = document.getElementById('startTestBtn');
            const stopBtn = document.getElementById('stopTestBtn');
            const testCaseItems = document.querySelectorAll('.test-case-item');
            
            // è·å–ä¸‹è½½å’Œæ¸…ç©ºæ—¥å¿—æŒ‰é’®
            const downloadBtns = document.querySelectorAll('.download-actions .btn');
            
            // æ§åˆ¶å¼€å§‹æµ‹è¯•æŒ‰é’®
            if (startBtn) {
                if (isOccupied && selectedTestCase) {
                    startBtn.disabled = false;
                } else {
                    startBtn.disabled = true;
                }
            }
            
            // æ§åˆ¶æµ‹è¯•ç”¨ä¾‹é€‰æ‹©
            testCaseItems.forEach(item => {
                if (isOccupied) {
                    item.style.pointerEvents = 'auto';
                    item.style.opacity = '1';
                } else {
                    item.style.pointerEvents = 'none';
                    item.style.opacity = '0.5';
                    item.classList.remove('selected');
                }
            });
            
            // æ§åˆ¶ä¸‹è½½æŠ¥å‘Šã€ä¸‹è½½æ—¥å¿—ã€æ¸…ç©ºæ—¥å¿—æŒ‰é’®
            downloadBtns.forEach(btn => {
                if (isOccupied) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.pointerEvents = 'auto';
                } else {
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.style.pointerEvents = 'none';
                }
            });
            
            // å¦‚æœé‡Šæ”¾å ç”¨ï¼Œæ¸…é™¤é€‰ä¸­çš„æµ‹è¯•ç”¨ä¾‹
            if (!isOccupied) {
                selectedTestCase = null;
            }
        }
        
        // åˆå§‹åŒ–æµ‹è¯•æœºé¡µé¢çŠ¶æ€
        function initializeTestMachineState() {
            // é»˜è®¤å…³é—­å ç”¨å¼€å…³
            document.getElementById('occupySwitch').checked = false;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonStates();
            
            // æ¸…é™¤é€‰ä¸­çš„æµ‹è¯•ç”¨ä¾‹
            selectedTestCase = null;
        }
        
        // åŠ è½½æµ‹è¯•æœºçš„å¼€å…³çŠ¶æ€
        async function loadSwitchStates(hostIp) {
            try {
                const response = await fetch(`http://localhost:5002/api/hosts/${hostIp}/switch_status`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const switchStates = result.data;
                    
                    // æ›´æ–°å¼€å…³çŠ¶æ€
                    if (switchStates.occupy !== undefined) {
                        document.getElementById('occupySwitch').checked = switchStates.occupy;
                    }
                    
                    addLog('info', '[INFO] å·²åŠ è½½æµ‹è¯•æœºå¼€å…³çŠ¶æ€');
                }
            } catch (error) {
                console.error('åŠ è½½å¼€å…³çŠ¶æ€å¤±è´¥:', error);
                addLog('warn', '[WARN] æ— æ³•åŠ è½½æµ‹è¯•æœºå¼€å…³çŠ¶æ€ï¼Œä½¿ç”¨é»˜è®¤çŠ¶æ€');
                resetSwitchStates();
            }
        }
        
        // è‡ªåŠ¨å‘ç°ä¸»æœº
        async function discoverHosts() {
            try {
                const response = await fetch('http://localhost:5002/api/discover');
                const result = await response.json();
                alert(`å‘ç°å®Œæˆï¼${result.message}`);
                refreshHosts();
            } catch (error) {
                console.error('è‡ªåŠ¨å‘ç°å¤±è´¥:', error);
                alert('è‡ªåŠ¨å‘ç°å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // æ˜¾ç¤ºæ·»åŠ ä¸»æœºæ¨¡æ€æ¡†
        function showAddHostModal() {
            document.getElementById('addHostModal').style.display = 'block';
        }
        
        // å…³é—­æ·»åŠ ä¸»æœºæ¨¡æ€æ¡†
        function closeAddHostModal() {
            document.getElementById('addHostModal').style.display = 'none';
            document.getElementById('addHostForm').reset();
        }
        
        // æ·»åŠ ä¸»æœºè¡¨å•æäº¤
        document.getElementById('addHostForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const hostData = Object.fromEntries(formData);
            
            try {
                const response = await fetch('http://localhost:5002/api/hosts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(hostData)
                });
                
                if (response.ok) {
                    alert('ä¸»æœºæ·»åŠ æˆåŠŸï¼');
                    closeAddHostModal();
                    refreshHosts();
                } else {
                    const error = await response.json();
                    alert(`æ·»åŠ å¤±è´¥: ${error.error}`);
                }
            } catch (error) {
                console.error('æ·»åŠ ä¸»æœºå¤±è´¥:', error);
                alert('æ·»åŠ ä¸»æœºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        });
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const addModal = document.getElementById('addHostModal');
            if (event.target === addModal) {
                closeAddHostModal();
            }
        }
    </script>
</body>
</html>